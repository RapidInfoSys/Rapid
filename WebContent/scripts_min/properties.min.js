var _listeners=[];var _dialogueListeners=[];function showProperties(control){for(var i in _listeners){_listeners[i].unbind()}var propertiesPanel=$(".propertiesPanelDiv");propertiesPanel.parent().css("height","auto");if(control){var controlClass=_controlTypes[control.type];propertiesPanel.html("<h2>Properties<img id='helpProperties' class='headerHelp' src='images/help_16x16.png' /></h2>");addHelp("helpProperties",true);propertiesPanel.append("<table class='propertiesPanelTable'><tbody></tbody></table>");var propertiesTable=propertiesPanel.children().last().children().last();propertiesTable.append("<tr><td colspan='2'><h3>"+controlClass.name+"</h3></td></tr>");propertiesTable.append("<tr><td colspan='2'></td></tr>");if(_version.showControlIds){propertiesTable.append("<tr><td>ID</td><td class='canSelect'>"+control.id+"</td></tr>")}var properties=controlClass.properties;if(properties){if($.isArray(properties.property)){properties=properties.property}for(var i in properties){propertiesTable.append("<tr></tr>");
var propertiesRow=propertiesTable.children().last();var property=properties[i];if(property.visible===undefined||!property.visible===false){propertiesRow.append("<td>"+property.name+"</td><td></td>");var cell=propertiesRow.children().last();if(property.changeValueJavaScript.trim().indexOf("function(")==0){try{var changeValueFunction=new Function(property.changeValueJavaScript);changeValueFunction.apply(this,[cell,control,property])}catch(ex){alert("Error - Couldn't apply changeValueJavaScript for "+control.name+"."+property.name+" "+ex)}}else{if(window["Property_"+property.changeValueJavaScript]){window["Property_"+property.changeValueJavaScript](cell,control,property,true)}else{alert("Error - There is no known Property_"+property.changeValueJavaScript+" function")}}}}}}}function updateProperty(propertyObject,property,value,refreshHtml){if(!_locked){addUndo();propertyObject[property.key]=value;if(refreshHtml){rebuildHtml(propertyObject)}if(property.key=="name"){if($("#pageMap").is(":visible")){var controlClass=_controlTypes[propertyObject.type];
$("#pageMap").find("span[data-id="+propertyObject.id+"]").html(((controlClass.image)?"<img src='"+controlClass.image+"'/>":"")+propertyObject.type+(propertyObject.name?" - "+propertyObject.name:""))}}}}function setPropertyVisibilty(propertyObject,propertyKey,visibile){var objectClass=_controlTypes[propertyObject.type];if(!objectClass){objectClass=_actionTypes[propertyObject.type]}if(propertyObject&&objectClass&&objectClass.properties){var properties=objectClass.properties;if($.isArray(properties.property)){properties=properties.property}for(var i in properties){var property=properties[i];if(property.key==propertyKey){property.visible=visibile;break}}}}function createDialogue(cell,width,title){var dialogue=$("#propertiesDialogues").append("<div class='actionsPanelDiv dialogue' style='position:absolute;display:none;width:"+width+"px;z-index:10012;border:1px solid black;background-color:white;font-size:11px;padding:10px;'></div>").children().last();var close=dialogue.append("<b style='float:left;margin-top:-5px;'>"+title+"</b><a href='#' style='float:right;margin-top:-5px;'>close</a></div>").children().last();
_dialogueListeners.push(close.click(function(ev){$(ev.target).closest("div.dialogue").remove();showProperties(_selectedControl);showEvents(_selectedControl);windowResize("PropertyDialogue")}));_listeners.push(cell.click(function(ev){dialogue.css({left:cell.offset().left+cell.outerWidth()-dialogue.outerWidth()+1,top:cell.offset().top});dialogue.slideDown(500)}));dialogue.append("<br/><table style='width:100%' class='propertiesPanelTable'><tbody></tbody></table>");return dialogue}function hideDialogues(){var propertiesDialogues=$("#propertiesDialogues");propertiesDialogues.children().remove();for(var i in _dialogueListeners){_dialogueListeners[i].unbind()}}function Property_text(cell,propertyObject,property,refreshHtml){var value="";if(propertyObject[property.key]){value=propertyObject[property.key]}cell.append("<input class='propertiesPanelTable' value='"+value+"' />");var input=cell.children().last();_listeners.push(input.keyup(function(ev){updateProperty(propertyObject,property,ev.target.value,refreshHtml)
}))}function Property_integer(cell,propertyObject,property,refreshHtml){var value="";if(propertyObject[property.key]){value=propertyObject[property.key]}cell.append("<input class='propertiesPanelTable' value='"+value+"' />");var input=cell.children().last();_listeners.push(input.keyup(function(ev){var input=$(ev.target);var val=input.val();if(val.match(new RegExp("^\\d+$"))){updateProperty(propertyObject,property,ev.target.value,refreshHtml)}else{input.val(propertyObject[property.key])}}))}function Property_bigtext(cell,propertyObject,property,refreshHtml){var value="";if(propertyObject[property.key]){value=propertyObject[property.key]}cell.text(value);var textarea=$("#propertiesDialogues").append("<textarea style='position:absolute;display:none;height:300px;width:600px;z-index:10012' wrap='off'></textarea>").children().last();textarea.text(value);_listeners.push(cell.click({textarea:textarea},function(ev){textarea.css({left:cell.offset().left+cell.outerWidth()-605,top:cell.offset().top});
textarea.slideDown(500);textarea.focus()}));_listeners.push(textarea.blur({cell:cell,textarea:textarea},function(ev){cell.text(textarea.val());textarea.hide()}));_listeners.push(textarea.keyup({cell:cell,textarea:textarea},function(ev){updateProperty(propertyObject,property,textarea.val(),refreshHtml)}))}function Property_select(cell,propertyObject,property,refreshHtml,refreshProperties){var options="";var js=property.getValuesFunction;try{var f=new Function(js);var values=f.apply(propertyObject,[]);if($.isArray(values)){for(var i in values){if($.type(values[i])=="string"||$.type(values[i])=="number"||$.type(values[i])=="boolean"){if(propertyObject[property.key]==values[i]){options+="<option selected='selected'>"+values[i]+"</option>"}else{options+="<option>"+values[i]+"</option>"}}else{var value=values[i].value;if(!value){value=values[i][0]}var text=values[i].text;if(!text){text=values[i][1]}if(!text){text=value}if(propertyObject[property.key]==value){options+="<option value='"+value+"' selected='selected'>"+text+"</option>"
}else{options+="<option value='"+value+"'>"+text+"</option>"}}}}else{options=values}}catch(ex){alert("getValuesFunction failed for "+propertyObject.type+". "+ex+"\r\r"+js)}cell.append("<select class='propertiesPanelTable'>"+options+"</select>");var select=cell.children().last();_listeners.push(select.change({refreshProperties:refreshProperties},function(ev){updateProperty(propertyObject,property,ev.target.value,refreshHtml);if(ev.data.refreshProperties){showProperties(_selectedControl)}}));if(!propertyObject[property.key]){propertyObject[property.key]=select.val()}}function Property_checkbox(cell,propertyObject,property,refreshHtml){var checked="";if(propertyObject[property.key]&&propertyObject[property.key]!="false"){checked="checked='checked'"}cell.append("<input class='propertiesPanelTable' type='checkbox' "+checked+" />");var input=cell.children().last();_listeners.push(input.change(function(ev){updateProperty(propertyObject,property,ev.target.checked,refreshHtml)}))}function Property_galleryImages(cell,gallery,property,refreshHtml,refreshDialogue){var dialogue=refreshDialogue;
if(!dialogue){dialogue=createDialogue(cell,200,"Images")}var table=dialogue.find("table").first();table.children().remove();if(!gallery.images){gallery.images=[]}var images=gallery.images;var text="";for(var i in images){text+=images[i].url;if(i<images.length-1){text+=","}}if(text){cell.html(text)}else{cell.html("Click to add...")}table.append("<tr><td  colspan='3' style='text-align:center;'>Url</td></tr>");for(var i in images){var image=images[i];table.append("<tr><td><input value='"+image.url+"' /></td><td style='width:32px'><img class='delete' src='images/bin_16x16.png' style='float:right;' /><img class='reorder' src='images/moveUpDown_16x16.png' style='float:right;' /></td></tr>")}_listeners.push(table.find("input").keyup(function(ev){var input=$(ev.target);var image=images[input.closest("tr").index()-1];image.url=input.val();updateProperty(gallery,property,images,refreshHtml)}));_listeners.push(table.find("img.delete").click(function(ev){addUndo();var img=$(ev.target);images.splice(img.index()-1);
rebuildHtml(gallery);Property_galleryImages(cell,gallery,property,refreshHtml,dialogue)}));addReorder(images,table.find("img.reorder"),function(){rebuildHtml(gallery);Property_galleryImages(cell,gallery,property,refreshHtml,dialogue)});table.append("<tr><td colspan='3'><a href='#'>add...</a></td></tr>");_listeners.push(table.find("a").click(function(ev){images.push({url:""});Property_galleryImages(cell,gallery,property,refreshHtml,dialogue)}))}function Property_imageFile(cell,propertyObject,property,refreshHtml,refreshDialogue){var dialogue=refreshDialogue;if(!dialogue){dialogue=createDialogue(cell,200,"Image file")}var table=dialogue.find("table").first();table.children().remove();var value="";if(propertyObject[property.key]){value=propertyObject[property.key]}if(value){cell.html(value)}else{cell.html("Click to add...")}if(_version.images){table.append("<tr><td><select><option>Please select...</option></select></td></tr>");var dropdown=table.find("select");for(var i in _version.images){var selected="";
if(_version.images[i]==propertyObject.file){selected=" selected='selected'"}dropdown.append("<option"+selected+">"+_version.images[i]+"</option>")}_listeners.push(dropdown.change(function(ev){var file=$(this).val();updateProperty(propertyObject,property,file,refreshHtml)}))}table.append("<tr><td><form id='form_"+propertyObject.id+"' method='post' enctype='multipart/form-data' target='uploadIFrame' action='designer?action=uploadImage&a="+_version.id+"&v="+_version.id.version+"&p="+_page.id+"&c="+propertyObject.id+"'><input id='file_"+propertyObject.id+"' name='file' type='file'></input></form></td></tr><tr><td><input type='submit' value='Upload' /></td></tr>");_listeners.push(table.find("input[type=submit]").click({id:propertyObject.id},function(ev){var file=$("#file_"+ev.data.id).val();if(file){$("#form_"+ev.data.id).submit()}}))}function Property_linkType(cell,propertyObject,property,refreshHtml){Property_select(cell,propertyObject,{key:"linkType",getValuesFunction:'return [["P","Page"],["U","URL"]];'},refreshHtml,true)
}function Property_linkPage(cell,propertyObject,property,refreshHtml){if(propertyObject.linkType=="P"){Property_select(cell,propertyObject,{key:"page",getValuesFunction:"return \"<option value=''>Please select...</option>\" + getPageOptions(this.page, _page.id);"},refreshHtml,true)}else{cell.parent().remove()}}function Property_linkURL(cell,propertyObject,property,refreshHtml){if(propertyObject.linkType=="U"){Property_bigtext(cell,propertyObject,property,refreshHtml)}else{cell.parent().remove()}}function Property_linkPopup(cell,propertyObject,property,refreshHtml){if(propertyObject.linkType=="U"){Property_checkbox(cell,propertyObject,property,refreshHtml)}else{cell.parent().remove()}}function Property_pageName(cell,page,property,refreshHtml,refreshDialogue){var value=page.name;cell.append("<input class='propertiesPanelTable' value='"+value+"' />");var input=cell.children().last();_listeners.push(input.keyup(function(ev){var input=$(ev.target);var val=input.val();var safeVal="";var pos=input.caret();
for(var i=0;i<val.length;i++){var c=val.charCodeAt(i);if((c>=48&&c<=57)||(c>=65&&c<=90)||(c>=97&&c<=122)||c==45||c==95){safeVal+=val.charAt(i)}else{pos--}}if(val!=safeVal){input.val(safeVal);input.caret(pos);val=safeVal}updateProperty(page,{key:"name"},val,refreshHtml)}))}function Property_validationControls(cell,propertyObject,property,refreshHtml,refreshDialogue){var dialogue=refreshDialogue;if(!dialogue){dialogue=createDialogue(cell,200,"Controls")}var table=dialogue.find("table").first();table.children().remove();var controls=[];if(propertyObject[property.key]){controls=propertyObject[property.key]}var text="";for(var i=0;i<controls.length;i++){var control=getControlById(controls[i]);if(control){text+=control.name}if(text&&i<controls.length-1){text+=","}}if(!text){text="Click to add"}cell.append(text);for(var i in controls){var control=getControlById(controls[i]);if(control){table.append("<tr><td>"+control.name+"</td><td style='width:32px'><img class='delete' src='images/bin_16x16.png' style='float:right;' /><img class='reorder' src='images/moveUpDown_16x16.png' style='float:right;' /></td></tr>")
}else{controls.splice(i,1)}}_listeners.push(table.find("img.delete").click(function(ev){var row=$(this).parent().parent();propertyObject.controls.splice(row.index(),1);row.remove()}));addReorder(controls,table.find("img.reorder"),function(){Property_validationControls(cell,propertyObject,property,refreshHtml,dialogue)});var addControl=table.append("<tr><td colspan='2'><select><option value=''>Add control...</option>"+getValidationControlOptions()+"</select></td></tr>").children().last().children().last().children().last();_listeners.push(addControl.change({cell:cell,propertyObject:propertyObject,refreshHtml:refreshHtml,refreshDialogue:dialogue},function(ev){var dropdown=$(ev.target);var controlId=dropdown.val();if(controlId){if(!propertyObject.controls){propertyObject.controls=[]}propertyObject.controls.push(controlId);dropdown.val("");Property_validationControls(ev.data.cell,ev.data.propertyObject,{key:"controls"},ev.data.refreshHtml,ev.data.refreshDialogue)}}))}function Property_childActions(cell,propertyObject,property,refreshHtml,refreshDialogue){var dialogue=refreshDialogue;
if(!dialogue){dialogue=createDialogue(cell,200,"Actions")}var table=dialogue.children().last().children().last();table.children().remove();var actions=[];if(propertyObject[property.key]){actions=propertyObject[property.key]}var text="";for(var i=0;i<actions.length;i++){text+=actions[i].type;if(i<actions.length-1){text+=","}}if(!text){text="Click to add..."}cell.text(text);for(var i in actions){var action=actions[i];showAction(table,action,actions,function(){Property_childActions(cell,propertyObject,property,refreshHtml,dialogue)})}addReorder(actions,table.find("img.reorder"),function(){Property_childActions(cell,propertyObject,property,refreshHtml,dialogue)});if(actions.length>0){table.append("<tr><td colspan='2'></td></tr>")}var addAction=table.append("<tr><td colspan='2'><select><option value=''>Add action...</option>"+_actionOptions+"</select></td></tr>").children().last().children().last().children().last();_listeners.push(addAction.change({cell:cell,propertyObject:propertyObject,property:property,refreshHtml:refreshHtml,dialogue:dialogue},function(ev){var dropdown=$(ev.target);
var actionType=dropdown.val();if(actionType){var propertyObject=ev.data.propertyObject;var property=ev.data.property;if(!propertyObject[property.key]){propertyObject[property.key]=[]}var action=new Action(actionType);propertyObject[property.key].push(action);dropdown.val("");Property_childActions(ev.data.cell,propertyObject,property,ev.data.refreshHtml,ev.data.dialogue)}}))}function Property_databaseQuery(cell,propertyObject,property,refreshHtml,refreshDialogue){var dialogue=refreshDialogue;if(!dialogue){dialogue=createDialogue(cell,1000,"Query")}var table=dialogue.children().last().children().last();table.children().remove();if(!propertyObject.query){propertyObject.query={inputs:[],sql:"select field1, field2\nfrom table\nwhere field3 = ?",databaseConnectionIndex:0,outputs:[]}}var query=propertyObject.query;var text=query.SQL;if(!text){text="Click to define..."}cell.text(text);table.append("<tr><td colspan='2' rowspan='3' style='padding:0px;vertical-align: top;'><table style='width:100%'><tr><td><b>Input</b></td><td colspan='2'><b>Field</b></td></tr></table></td><td colspan='2' style='width:500px;padding:0px 6px 0px 0px;'><b>SQL</b><br/><textarea style='width:100%;min-height:300px;'></textarea></td><td colspan='2' rowspan='3' style='padding:0px;vertical-align: top;'><table style='width:100%'><tr><td><b>Field</b></td><td colspan='2'><b>Output</b></td></tr></table></td></tr>");
var inputsTable=table.children().last().children().first().children().last();for(var i in query.inputs){var itemName=query.inputs[i].itemId;var control=getControlById(itemName);if(control){itemName=control.name}var field=query.inputs[i].field;if(!field){field=""}inputsTable.append("<tr><td>"+itemName+"</td><td><input value='"+field+"' /></td><td style='width:32px;'><img class='delete' src='images/bin_16x16.png' style='float:right;' /><img class='reorder' src='images/moveUpDown_16x16.png' style='float:right;' /></td></tr>");var fieldInput=inputsTable.find("tr").last().children(":nth(1)").last().children().last();_listeners.push(fieldInput.keyup({parameters:query.inputs},function(ev){var input=$(ev.target);ev.data.parameters[input.parent().parent().index()-1].field=input.val()}));var fieldDelete=inputsTable.find("tr").last().children().last().children("img.delete");_listeners.push(fieldDelete.click({parameters:query.inputs},function(ev){var input=$(ev.target);ev.data.parameters.splice(input.parent().parent().index()-1,1);
input.parent().parent().remove()}))}addReorder(query.inputs,inputsTable.find("img.reorder"),function(){Property_databaseQuery(cell,propertyObject,{key:"query"},refreshHtml,dialogue)});inputsTable.append("<tr><td style='padding:0px;'><select style='margin:0px'><option value=''>Add input...</option>"+getInputOptions()+"</select></td><td>&nbsp;</td><td>&nbsp;</td></tr>");var inputAdd=inputsTable.find("tr").last().children().first().children().first();_listeners.push(inputAdd.change({cell:cell,propertyObject:propertyObject,refreshHtml:refreshHtml,dialogue:dialogue},function(ev){if(!ev.data.propertyObject.query.inputs){ev.data.propertyObject.query.inputs=[]}var parameters=ev.data.propertyObject.query.inputs;parameters.push({itemId:$(ev.target).val(),field:""});Property_databaseQuery(ev.data.cell,ev.data.propertyObject,{key:"query"},ev.data.refreshHtml,ev.data.dialogue)}));var sqlControl=table.find("textarea").first();sqlControl.text(query.SQL);_listeners.push(sqlControl.keyup({query:query},function(ev){query.SQL=$(ev.target).val()
}));var outputsTable=table.children().last().children().last().children().last();for(var i in query.outputs){var itemName=query.outputs[i].itemId;var control=getControlById(itemName);if(control){itemName=control.name}var field=query.outputs[i].field;if(!field){field=""}outputsTable.append("<tr><td><input value='"+field+"' /></td><td>"+itemName+"</td><td style='width:32px;'><img class='delete' src='images/bin_16x16.png' style='float:right;' /><img class='reorder' src='images/moveUpDown_16x16.png' style='float:right;' /></td></tr>");var fieldOutput=outputsTable.find("tr").last().children().first().children().last();_listeners.push(fieldOutput.keyup({parameters:query.outputs},function(ev){var input=$(ev.target);ev.data.parameters[input.parent().parent().index()-1].field=input.val()}));var fieldDelete=outputsTable.find("tr").last().children().last().children("img.delete");_listeners.push(fieldDelete.click({parameters:query.outputs},function(ev){var input=$(ev.target);ev.data.parameters.splice(input.parent().parent().index()-1,1);
input.parent().parent().remove()}))}addReorder(query.outputs,outputsTable.find("img.reorder"),function(){Property_databaseQuery(cell,propertyObject,{key:"query"},refreshHtml,dialogue)});outputsTable.append("<tr><td>&nbsp;</td><td style='padding:0px;'><select style='margin:0px'><option value=''>Add output...</option>"+getOutputOptions()+"</select></td><td>&nbsp;</td></tr>");var outputAdd=outputsTable.find("tr").last().children(":nth(1)").last().children().last();_listeners.push(outputAdd.change({cell:cell,propertyObject:propertyObject,refreshHtml:refreshHtml,dialogue:dialogue},function(ev){if(!ev.data.propertyObject.query.outputs){ev.data.propertyObject.query.outputs=[]}var parameters=ev.data.propertyObject.query.outputs;parameters.push({itemId:$(ev.target).val(),field:""});Property_databaseQuery(ev.data.cell,ev.data.propertyObject,{key:"query"},ev.data.refreshHtml,ev.data.dialogue)}));table.append("<tr><td>Database connection <select style='width:auto;'>"+getDatabaseConnectionOptions(query.databaseConnectionIndex)+"</select></td><td style='text-align:right;'><button>Test SQL</button></td></tr>");
var dbConnection=table.find("tr").last().find("select");_listeners.push(dbConnection.change({query:query},function(ev){ev.data.query.databaseConnectionIndex=ev.target.selectedIndex}));var testSQL=table.find("tr").last().find("button");_listeners.push(testSQL.click({query:query},function(ev){var data=JSON.stringify(ev.data.query);$.ajax({url:"designer?a="+_version.id.id+"&v="+_version.id.version+"&action=testSQL",type:"POST",contentType:"application/json",dataType:"json",data:data,error:function(server,status,error){alert(error+" : "+server.responseText)},success:function(response){alert(response.message)}})}))}function Property_webserviceRequest(cell,propertyObject,property,refreshHtml,refreshDialogue){var dialogue=refreshDialogue;if(!dialogue){dialogue=createDialogue(cell,1000,"Webservice request")}var table=dialogue.children().last().children().last();table.children().remove();if(!propertyObject.request){propertyObject.request={inputs:[],type:"SOAP",url:"soa",action:"aaa.Samplewebservice",body:'<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:soa="http://soa.rapid-is.co.uk">\n  <soapenv:Body>\n    <soa:personSearchRequest>\n      <soa:surname>A</soa:surname>\n    </soa:personSearchRequest>\n  </soapenv:Body>\n</soapenv:Envelope>',outputs:[]}
}var request=propertyObject.request;var text=request.type;if(!text){text="Click to define..."}cell.text(text);table.append("<tr><td colspan='2' rowspan='3' style='padding:0px;vertical-align: top;'><table style='width:100%'><tr><td><b>Input</b></td><td colspan='2'><b>Field</b></td></tr></table></td><td colspan='2' style='width:500px;padding:0px 6px 0px 0px;'><b>Type</b><br/><input type='radio' name='WSType' value='SOAP'/>SOAP<input type='radio' name='WSType' value='JSON'/>JSON<input type='radio' name='WSType' value='XML'/>XML/Restfull</br><b>URL</b><br/><input class='WSUrl'/></br><b>Action</b><br/><input class='WSAction'/></br><b>Body</b><br/><textarea style='width:100%;min-height:300px;' class='WSBody'></textarea></td><td colspan='2' rowspan='3' style='padding:0px;vertical-align: top;'><table style='width:100%'><tr><td><b>Field</b></td><td colspan='2'><b>Output</b></td></tr></table></td></tr>");var inputsTable=table.children().last().children().first().children().last();for(var i in request.inputs){var itemName=request.inputs[i].itemId;
var control=getControlById(itemName);if(control){itemName=control.name}var field=request.inputs[i].field;if(!field){field=""}inputsTable.append("<tr><td>"+itemName+"</td><td><input value='"+field+"' /></td><td style='width:32px;'><img class='delete' src='images/bin_16x16.png' style='float:right;' /><img class='reorder' src='images/moveUpDown_16x16.png' style='float:right;' /></td></tr>");var fieldInput=inputsTable.find("tr").last().children(":nth(1)").last().children().last();_listeners.push(fieldInput.keyup({parameters:request.inputs},function(ev){var input=$(ev.target);ev.data.parameters[input.parent().parent().index()-1].field=input.val()}));var fieldDelete=inputsTable.find("tr").last().children().last().children("img.delete");_listeners.push(fieldDelete.click({parameters:request.inputs},function(ev){var input=$(ev.target);ev.data.parameters.splice(input.parent().parent().index()-1,1);input.parent().parent().remove()}))}addReorder(request.inputs,inputsTable.find("img.reorder"),function(){Property_webserviceRequest(cell,propertyObject,{key:"request"},refreshHtml,dialogue)
});inputsTable.append("<tr><td style='padding:0px;'><select style='margin:0px'><option value=''>Add input...</option>"+getInputOptions()+"</select></td><td>&nbsp;</td><td>&nbsp;</td></tr>");var inputAdd=inputsTable.find("tr").last().children().first().children().first();_listeners.push(inputAdd.change({cell:cell,propertyObject:propertyObject,refreshHtml:refreshHtml,dialogue:dialogue},function(ev){if(!ev.data.propertyObject.request.inputs){ev.data.propertyObject.request.inputs=[]}var parameters=ev.data.propertyObject.request.inputs;parameters.push({itemId:$(ev.target).val(),field:""});Property_webserviceRequest(ev.data.cell,ev.data.propertyObject,{key:"request"},ev.data.refreshHtml,ev.data.dialogue)}));var typeControls=table.find("input[type=radio]");typeControls.filter("[value="+request.type+"]").prop("checked","true");_listeners.push(typeControls.click({request:request},function(ev){request.type=$(ev.target).val()}));var actionControl=table.find("input.WSUrl");actionControl.val(request.url);
_listeners.push(actionControl.keyup({request:request},function(ev){request.url=$(ev.target).val()}));var actionControl=table.find("input.WSAction");actionControl.val(request.action);_listeners.push(actionControl.keyup({request:request},function(ev){request.action=$(ev.target).val()}));var bodyControl=table.find("textarea");bodyControl.text(request.body);_listeners.push(bodyControl.keyup({request:request},function(ev){request.body=$(ev.target).val()}));var outputsTable=table.children().last().children().last().children().last();for(var i in request.outputs){var itemName=request.outputs[i].itemId;var control=getControlById(itemName);if(control){itemName=control.name}var field=request.outputs[i].field;if(!field){field=""}outputsTable.append("<tr><td><input value='"+field+"' /></td><td>"+itemName+"</td><td style='width:32px;'><img class='delete' src='images/bin_16x16.png' style='float:right;' /><img class='reorder' src='images/moveUpDown_16x16.png' style='float:right;' /></td></tr>");var fieldOutput=outputsTable.find("tr").last().children().first().children().last();
_listeners.push(fieldOutput.keyup({parameters:request.outputs},function(ev){var input=$(ev.target);ev.data.parameters[input.parent().parent().index()-1].field=input.val()}));var fieldDelete=outputsTable.find("tr").last().children().last().children("img.delete");_listeners.push(fieldDelete.click({parameters:request.outputs},function(ev){var input=$(ev.target);ev.data.parameters.splice(input.parent().parent().index()-1,1);input.parent().parent().remove()}))}addReorder(request.outputs,outputsTable.find("img.reorder"),function(){Property_webserviceRequest(cell,propertyObject,{key:"request"},refreshHtml,dialogue)});outputsTable.append("<tr><td>&nbsp;</td><td style='padding:0px;'><select style='margin:0px'><option value=''>Add output...</option>"+getOutputOptions()+"</select></td><td>&nbsp;</td></tr>");var outputAdd=outputsTable.find("tr").last().children(":nth(1)").last().children().last();_listeners.push(outputAdd.change({cell:cell,propertyObject:propertyObject,refreshHtml:refreshHtml,dialogue:dialogue},function(ev){if(!ev.data.propertyObject.request.outputs){ev.data.propertyObject.request.outputs=[]
}var parameters=ev.data.propertyObject.request.outputs;parameters.push({itemId:$(ev.target).val(),field:""});Property_webserviceRequest(ev.data.cell,ev.data.propertyObject,{key:"request"},ev.data.refreshHtml,ev.data.dialogue)}))}function Property_navigationPage(cell,navigationAction,property,refreshHtml,refreshDialogue){cell.append("<select><option value=''>Please select...</option>"+getPageOptions(navigationAction.page)+"</select>");var pageDropDown=cell.find("select").last();_listeners.push(pageDropDown.change({navigationAction:navigationAction},function(ev){ev.data.navigationAction.page=$(ev.target).val();showEvents(_selectedControl)}))}function Property_pageSessionVariables(cell,page,property,refreshHtml,refreshDialogue){var dialogue=refreshDialogue;if(!dialogue){dialogue=createDialogue(cell,200,"Page variables")}var table=dialogue.find("table").first();table.children().remove();var variables=[];if(page.sessionVariables){variables=page.sessionVariables}var text="";for(var i=0;i<variables.length;
i++){text+=variables[i];if(i<variables.length-1){text+=","}}if(!text){text="Click to add..."}cell.text(text);for(var i in variables){table.append("<tr><td style='padding-left:0px'><input class='variable' value='"+variables[i]+"' /></td><td><img src='images/bin_16x16.png' style='float:right;' /></td></tr>");var valueEdit=table.find("input.variable").last();_listeners.push(valueEdit.keyup({variables:variables},function(ev){var input=$(ev.target);ev.data.variables[input.parent().parent().index()]=input.val()}));var optionDelete=table.find("tr").last().children().last().children().last();_listeners.push(optionDelete.click({variables:variables},function(ev){var input=$(ev.target);ev.data.variables.splice(input.parent().parent().index(),1);input.parent().parent().remove()}))}table.append("<tr><td colspan='2'><a href='#'>add...</a></td></tr>");var add=table.find("tr").last().children().last().children().last();_listeners.push(add.click({cell:cell,page:page,refreshHtml:refreshHtml,dialogue:dialogue},function(ev){if(!ev.data.page.sessionVariables){ev.data.page.sessionVariables=[]
}ev.data.page.sessionVariables.push("");Property_pageSessionVariables(ev.data.cell,ev.data.page,{key:"sessionVariables"},ev.data.refreshHtml,ev.data.dialogue)}))}function Property_roles(cell,control,property,refreshHtml,refreshDialogue){var dialogue=refreshDialogue;if(!dialogue){dialogue=createDialogue(cell,200,"User roles")}var table=dialogue.find("table").first();table.children().remove();var roles=[];if(control.roles){roles=control.roles}var text="";for(var i=0;i<roles.length;i++){text+=roles[i];if(i<roles.length-1){text+=","}}if(!text){text="Click to add..."}cell.text(text);for(var i in roles){table.append("<tr><td style='padding-left:0px'>"+roles[i]+"</td><td><img src='images/bin_16x16.png' style='float:right;' /></td></tr>");var optionDelete=table.find("tr").last().children().last().children().last();_listeners.push(optionDelete.click({roles:roles,cell:cell,control:control,refreshHtml:refreshHtml,dialogue:dialogue},function(ev){var input=$(ev.target);ev.data.roles.splice(input.parent().parent().index(),1);
input.parent().parent().remove();Property_roles(ev.data.cell,ev.data.control,{key:"roles"},ev.data.refreshHtml,ev.data.dialogue)}))}table.append("<tr><td colspan='2'><select><option value=''>add...</option>"+getRolesOptions(null,roles)+"</td></tr>");var add=table.find("tr").last().children().last().children().last();_listeners.push(add.change({cell:cell,control:control,refreshHtml:refreshHtml,dialogue:dialogue},function(ev){if(!ev.data.control.roles){ev.data.control.roles=[]}var role=ev.target.value;if(role){ev.data.control.roles.push(role)}Property_roles(ev.data.cell,ev.data.control,{key:"roles"},ev.data.refreshHtml,ev.data.dialogue)}))}function Property_navigationSessionVariables(cell,navigation,property,refreshHtml,refreshDialogue){if(navigation.linkType&&navigation.linkType!="P"){cell.parent().remove();return false}var dialogue=refreshDialogue;if(!dialogue){dialogue=createDialogue(cell,300,"Set page variables")}var table=dialogue.find("table").first();table.children().remove();var page=null;
for(var i in _pages){if(_pages[i].id==navigation.page){page=_pages[i]}}if(page){if(!navigation.sessionVariables||navigation.sessionVariables=="[]"){navigation.sessionVariables=[]}var sessionVariables=navigation.sessionVariables;var text="";for(var i=0;i<sessionVariables.length;i++){text+=sessionVariables[i].name;if(i<sessionVariables.length-1){text+=","}}if(!text){text="Click to add..."}cell.text(text);table.append("<tr><td><b>Variable</b></td><td><b>Input</b></td><td><b>Field</b></td></tr>");for(var i in page.sessionVariables){var sessionVariable=sessionVariables[i];if(!sessionVariable||sessionVariable.name!=page.sessionVariables[i]){sessionVariable={name:page.sessionVariables[i],itemId:"",field:""};sessionVariables.splice(i,0,sessionVariable)}var name=sessionVariable.name;var control=getControlById(name);if(control){name=control.name}table.append("<tr><td>"+name+"</td><td><select><option value=''>Please select...</option>"+getInputOptions(sessionVariable.itemId)+"</select></td><td style='padding-left:0px'><input value='"+sessionVariable.field+"' /></td></tr>");
var itemEdit=table.find("select").last();_listeners.push(itemEdit.change({sessionVariables:sessionVariables},function(ev){var input=$(ev.target);ev.data.sessionVariables[input.parent().parent().index()-1].itemId=input.val()}));var fieldEdit=table.find("input").last();_listeners.push(fieldEdit.keyup({sessionVariables:sessionVariables},function(ev){var input=$(ev.target);ev.data.sessionVariables[input.parent().parent().index()-1].field=input.val()}))}if(sessionVariables.length>i){sessionVariables.splice(i*1+1,sessionVariables.length)}}else{cell.parent().hide()}}function Property_radiobuttons(cell,radiobuttons,property,refreshHtml,refreshDialogue){var dialogue=refreshDialogue;if(!dialogue){dialogue=createDialogue(cell,200,"Radio buttons")}var table=dialogue.find("table").first();table.children().remove();var buttons=[];if(radiobuttons.buttons){buttons=radiobuttons.buttons}var text="";for(var i=0;i<buttons.length;i++){text+=buttons[i].label;if(radiobuttons.codes){text+=" ("+buttons[i].value+")"
}if(i<buttons.length-1){text+=","}}if(!text){text="Click to add..."}cell.text(text);table.append("<tr>"+(radiobuttons.codes?"<td><b>Code</b></td>":"")+"<td colspan='2'><b>Text</b></td></tr>");for(var i in buttons){table.append("<tr>"+(radiobuttons.codes?"<td style='padding-left:0px'><input class='value' value='"+buttons[i].value+"' /></td>":"")+"<td style='padding-left:0px'><input class='label' value='"+buttons[i].label+"' /></td><td><img src='images/bin_16x16.png' style='float:right;' /></td></tr>");var valueEdit=table.find("input.value").last();_listeners.push(valueEdit.keyup({radiobuttons:radiobuttons,buttons:buttons},function(ev){var input=$(ev.target);ev.data.buttons[input.parent().parent().index()-1].value=input.val();rebuildHtml(ev.data.radiobuttons)}));var textEdit=table.find("input.label").last();_listeners.push(textEdit.keyup({radiobuttons:radiobuttons,buttons:buttons},function(ev){var input=$(ev.target);ev.data.buttons[input.parent().parent().index()-1].label=input.val();rebuildHtml(ev.data.radiobuttons)
}));var buttonDelete=table.find("tr").last().children().last().children().last();_listeners.push(buttonDelete.click({cell:cell,radiobuttons:radiobuttons,refreshHtml:refreshHtml,dialogue:dialogue},function(ev){var delImage=$(ev.target);ev.data.radiobuttons.buttons.splice(delImage.parent().parent().index()-1,1);delImage.parent().parent().remove();if(delImage.parent().index()==1){rebuildHtml(ev.data.radiobuttons)}Property_radiobuttons(ev.data.cell,ev.data.radiobuttons,{key:"buttons"},ev.data.refreshHtml,ev.data.dialogue)}))}table.append("<tr><td colspan='"+(radiobuttons.codes?"3":"2")+"'><a href='#'>add...</a></td></tr>");var add=table.find("tr").last().children().last().children().last();_listeners.push(add.click({cell:cell,radiobuttons:radiobuttons,refreshHtml:refreshHtml,dialogue:dialogue},function(ev){ev.data.radiobuttons.buttons.push({value:"",label:""});Property_radiobuttons(ev.data.cell,ev.data.radiobuttons,{key:"buttons"},ev.data.refreshHtml,ev.data.dialogue)}));if(!dialogue.find("input[type=checkbox]")[0]){dialogue.append("Use codes <input type='checkbox' "+(radiobuttons.codes?"checked='checked'":"")+" />");
var optionsCodes=dialogue.children().last();_listeners.push(optionsCodes.change({cell:cell,radiobuttons:radiobuttons,buttons:buttons,refreshHtml:refreshHtml,dialogue:dialogue},function(ev){ev.data.radiobuttons.codes=ev.target.checked;Property_radiobuttons(ev.data.cell,ev.data.radiobuttons,{key:"buttons"},ev.data.refreshHtml,ev.data.dialogue)}))}}var _logicOperations=[["==","= equals"],["!=","!= doesn't equal"],[">","> greater than"],[">=",">= greater than or equal to"],["<","< less than"],["<=","<= less than or equal to"]];function logicConditionText(condition){var text="Not set";switch(condition.type){case"CTL":var control=null;var idParts=condition.id.split(".");var controlId=idParts;if(idParts.length>1){controlId=idParts[0]}if(controlId){control=getControlById(controlId)}text=(control?control.name:condition.id);if(idParts.length>1){text+="."+idParts[1]}if(condition.field){text+="."+condition.field}break;case"CNT":if(condition.constant){text=condition.constant}case"SYS":text=condition.id.split(".")[1];
break}return text}function logicConditionValue(cell,action,conditionIndex,valueId){var condition=action.conditions[conditionIndex];if(!condition[valueId]){condition[valueId]={type:"CTL"}}var value=condition[valueId];cell.html("<table></table>");var table=cell.find("table").last();table.append("<tr><td>"+(valueId=="value1"?"Item 1":"Item 2")+"</td><td><select>"+getInputOptions(value.id)+"<optgroup label='User value'><option value='Constant.Constant'"+(value.id=="Constant.Constant"?" selected='selected'":"")+">User value</option></optgroup></select></td></tr>");var select=table.find("select");if(!value.id){value.id=select.val()}_listeners.push(table.find("select").change(function(ev){var id=$(ev.target).val();var type="CTL";if(id.substr(0,7)=="System."){type="SYS"}if(id=="Constant.Constant"){type="CNT"}value.type=type;value.id=id;logicConditionValue(cell,action,conditionIndex,valueId)}));switch(value.type){case"CTL":table.append("<tr><td>Field</td><td><input /></td></tr>");var input=table.find("input").last();
if(value.field){input.val(value.field)}_listeners.push(input.keyup(function(ev){value.field=$(ev.target).val()}));break;case"CNT":table.append("<tr><td>Value</td><td><input /></td></tr>");var input=table.find("input").last();if(value.constant){input.val(value.constant)}_listeners.push(input.keyup(function(ev){value.constant=$(ev.target).val()}));break}}function Property_logicConditions(cell,action,property,refreshHtml,refreshDialogue){var dialogue=refreshDialogue;if(!dialogue){dialogue=createDialogue(cell,500,"Conditions")}var table=dialogue.find("table").first();table.addClass("dialogueTable");table.children().remove();var conditions=action[property.key];if(!conditions){conditions=[]}var text="";for(var i in conditions){var condition=conditions[i];table.append("<tr><td style='vertical-align:top;'></td><td style='vertical-align:top;'></td><td style='vertical-align:top;'></td><td style='width:32px;'><img class='delete' src='images/bin_16x16.png' style='float:right;' /><img class='reorder' src='images/moveUpDown_16x16.png' style='float:right;' /></td></tr>");
var lastrow=table.find("tr").last();var value1Cell=lastrow.children("td:nth(0)");var value2Cell=lastrow.children("td:nth(2)");var operationCell=lastrow.children("td:nth(1)");logicConditionValue(value1Cell,action,i,"value1");logicConditionValue(value2Cell,action,i,"value2");var operationHtml="<select style='margin-top:1px;'>";for(var j in _logicOperations){operationHtml+="<option value='"+_logicOperations[j][0]+"'"+(condition.operation==_logicOperations[j][0]?" selected='selected'":"")+">"+_logicOperations[j][1]+"</option>"}operationHtml+="</select>";operationCell.append(operationHtml);operationCell.find("select").last().change({condition:condition},function(ev){ev.data.condition.operation=$(ev.target).val()});text+=logicConditionText(condition.value1)+" "+(condition.operation=="=="?"=":condition.operation)+" "+logicConditionText(condition.value2);if(i<conditions.length-1){text+=" "+action.conditionsType+" "}}if(!text){text="click to add..."}cell.text(text);var deleteImages=table.find("img.delete");
_listeners.push(deleteImages.click({conditions:conditions},function(ev){var delImage=$(ev.target);ev.data.conditions.splice(delImage.parent().parent().index(),1);if(ev.data.conditions.length<2){$(ev.target).closest("table").find("tr:last").prev().remove()}delImage.parent().parent().remove()}));addReorder(conditions,table.find("img.reorder"),function(){Property_logicConditions(cell,action,{key:"conditions"},refreshHtml,dialogue)});if(conditions.length>1){table.append("<tr><td colspan='4' style='padding-left:12px;'><input type='radio' name='"+action.id+"type' value='and'"+(action.conditionsType=="and"?" checked='checked'":"")+"/>all conditions must be true (And) <input type='radio' name='"+action.id+"type' value='or'"+(action.conditionsType=="or"?" checked='checked'":"")+"/>any condition can be true (Or) </td></tr>");table.find("input[name="+action.id+"type]").change(function(ev){action.conditionsType=$(ev.target).val()})}table.append("<tr><td colspan='4'><a href='#'>add...</a></td></tr>");
table.find("a").last().click(function(ev){if(!action.conditions){action.conditions=[]}action.conditions.push({value1:{type:"CTL"},operation:"==",value2:{type:"CTL"}});Property_logicConditions(cell,action,property,refreshHtml,dialogue)})}function Property_options(cell,dropdown,property,refreshHtml,refreshDialogue){var dialogue=refreshDialogue;if(!dialogue){dialogue=createDialogue(cell,200,"Options")}var table=dialogue.find("table").first();table.children().remove();var options=[];if(dropdown.options){options=dropdown.options}var text="";for(var i=0;i<options.length;i++){text+=options[i].text;if(dropdown.codes){text+=" ("+options[i].value+")"}if(i<options.length-1){text+=","}}if(!text){text="Click to add..."}cell.text(text);table.append("<tr><td><b>Text</b></td>"+(dropdown.codes?"<td colspan='2'><b>Code</b></td>":"")+"</tr>");for(var i in options){table.append("<tr><td style='padding-left:0px'><input class='text' value='"+options[i].text+"' /></td>"+(dropdown.codes?"<td style='padding-left:0px'><input class='value' value='"+options[i].value+"' /></td>":"")+"<td style='width:32px;'><img class='delete' src='images/bin_16x16.png' style='float:right;' /><img class='reorder' src='images/moveUpDown_16x16.png' style='float:right;' /></td></tr>");
var textEdit=table.find("input.text").last();_listeners.push(textEdit.keyup({dropdown:dropdown,options:options},function(ev){var input=$(ev.target);ev.data.options[input.parent().parent().index()-1].text=input.val();if(input.parent().parent().index()==1){rebuildHtml(dropdown)}}));var valueEdit=table.find("input.value").last();_listeners.push(valueEdit.keyup({options:options},function(ev){var input=$(ev.target);ev.data.options[input.parent().parent().index()-1].value=input.val()}))}var deleteImages=table.find("img.delete");_listeners.push(deleteImages.click({options:options},function(ev){var delImage=$(ev.target);ev.data.options.splice(delImage.parent().parent().index()-1,1);delImage.parent().parent().remove();if(delImage.parent().index()==1){rebuildHtml(dropdown)}}));addReorder(options,table.find("img.reorder"),function(){rebuildHtml(dropdown);Property_options(cell,dropdown,{key:"options"},refreshHtml,dialogue)});table.append("<tr><td colspan='"+(dropdown.codes?"3":"2")+"'><a href='#'>add...</a></td></tr>");
var add=table.find("tr").last().children().last().children().last();_listeners.push(add.click({cell:cell,dropdown:dropdown,refreshHtml:refreshHtml,dialogue:dialogue},function(ev){ev.data.dropdown.options.push({value:"",text:""});Property_options(ev.data.cell,ev.data.dropdown,{key:"options"},ev.data.refreshHtml,ev.data.dialogue)}));if(!dialogue.find("input[type=checkbox]")[0]){dialogue.append("Use codes <input type='checkbox' "+(dropdown.codes?"checked='checked'":"")+" />");var optionsCodes=dialogue.children().last();_listeners.push(optionsCodes.change({cell:cell,dropdown:dropdown,options:options,refreshHtml:refreshHtml,dialogue:dialogue},function(ev){dropdown.codes=ev.target.checked;Property_options(ev.data.cell,ev.data.dropdown,{key:"options"},ev.data.refreshHtml,ev.data.dialogue)}))}}function Property_gridColumns(cell,grid,property,refreshHtml,refreshDialogue){var dialogue=refreshDialogue;if(!dialogue){dialogue=createDialogue(cell,650,"Columns")}var table=dialogue.find("table").first();
table.children().remove();var columns=grid.columns;if(!columns||columns=="[]"){columns=[]}var text="";for(var i=0;i<columns.length;i++){text+=columns[i].title;if(i<columns.length-1){text+=","}}if(!text){text="Click to add..."}cell.text(text);table.append("<tr><td style='width:20px;'><b>Visible</b></td><td><b>Title</b></td><td><b>Title style</b></td><td><b>Field</b></td><td><b>Field style</b></td><td colspan='2'><b>Cell function</b></td></tr>");for(var i in columns){var cellFunctionText="...";if(columns[i].cellFunction){cellFunctionText=columns[i].cellFunction}table.append("<tr><td style='text-align:center;'><input type='checkbox' "+(columns[i].visible?"checked='checked'":"")+" /></td><td style='padding-left:0px'><input class='text' value='"+columns[i].title+"' /></td><td style='padding-left:0px'><input class='text' value='"+columns[i].titleStyle+"' /></td><td style='padding-left:0px'><input class='text' value='"+columns[i].field+"' /></td><td style='padding-left:0px'><input class='text' value='"+columns[i].fieldStyle+"' /></td><td style='width:20px;padding-left:5px'>"+cellFunctionText.replaceAll("<","&lt;")+"</td><td style='width:32px;'><img class='delete' src='images/bin_16x16.png' style='float:right;' /><img class='reorder' src='images/moveUpDown_16x16.png' style='float:right;' /></td></tr>");
var visibleEdit=table.find("tr").last().children(":nth(0)").first().children().first();_listeners.push(visibleEdit.change({grid:grid},function(ev){var input=$(ev.target);ev.data.grid.columns[input.parent().parent().index()-1].visible=ev.target.checked;rebuildHtml(grid)}));var titleEdit=table.find("tr").last().children(":nth(1)").first().children().first();_listeners.push(titleEdit.keyup({grid:grid},function(ev){var input=$(ev.target);ev.data.grid.columns[input.parent().parent().index()-1].title=input.val();rebuildHtml(grid)}));var titleStyleEdit=table.find("tr").last().children(":nth(2)").first().children().first();_listeners.push(titleStyleEdit.keyup({grid:grid},function(ev){var input=$(ev.target);ev.data.grid.columns[input.parent().parent().index()-1].titleStyle=input.val();rebuildHtml(grid)}));var fieldEdit=table.find("tr").last().children(":nth(3)").first().children().first();_listeners.push(fieldEdit.keyup({grid:grid},function(ev){var input=$(ev.target);ev.data.grid.columns[input.parent().parent().index()-1].field=input.val();
rebuildHtml(grid)}));var fieldStyleEdit=table.find("tr").last().children(":nth(4)").first().children().first();_listeners.push(fieldStyleEdit.keyup({grid:grid},function(ev){var input=$(ev.target);ev.data.grid.columns[input.parent().parent().index()-1].fieldStyle=input.val();rebuildHtml(grid)}));var fieldStyleEdit=table.find("tr").last().children(":nth(5)").first();_listeners.push(fieldStyleEdit.click({grid:grid},function(ev){var td=$(ev.target);var index=td.parent().index()-1;cellFunctionTextArea.attr("data-index",index);var cellFunctionText=ev.data.grid.columns[index].cellFunction;if(cellFunctionText){cellFunctionTextArea.val(cellFunctionText)}cellFunctionTextArea.show().focus()}))}var cellFunctionTextArea=dialogue.append("<textarea data-index='-1' style='position:absolute;display:none;width:500px;height:300px;top:26px;right:10px;'  wrap='off'></textarea>").find("textarea:first");_listeners.push(cellFunctionTextArea.blur(function(ev){var value=cellFunctionTextArea.val();if(!value){value="..."
}var index=cellFunctionTextArea.attr("data-index")*1;if(index>=0){table.find("tr:nth("+(index+1)+")").last().children("td:nth(5)").html(value)}cellFunctionTextArea.val("");cellFunctionTextArea.hide()}));_listeners.push(cellFunctionTextArea.keyup({grid:grid},function(ev){var index=cellFunctionTextArea.attr("data-index")*1;if(index>=0){ev.data.grid.columns[index].cellFunction=cellFunctionTextArea.val()}}));var deleteImages=table.find("img.delete");_listeners.push(deleteImages.click({columns:columns},function(ev){var input=$(ev.target);ev.data.columns.splice(input.parent().parent().index()-1,1);input.parent().parent().remove();rebuildHtml(grid)}));addReorder(columns,table.find("img.reorder"),function(){rebuildHtml(grid);Property_gridColumns(cell,grid,{key:"columns"},refreshHtml,dialogue)});table.append("<tr><td colspan='5'><a href='#'>add...</a></td></tr>");var add=table.find("tr").last().children().last().children().last();_listeners.push(add.click({cell:cell,grid:grid,refreshHtml:refreshHtml,dialogue:dialogue},function(ev){ev.data.grid.columns.push({visible:true,title:"",titleStyle:"",field:"",fieldStyle:"",cellFunction:""});
Property_gridColumns(ev.data.cell,ev.data.grid,{key:"columns"},ev.data.refreshHtml,ev.data.dialogue)}))}function Property_dataDestinations(cell,propertyObject,property,refreshHtml,refreshDialogue){var dialogue=refreshDialogue;if(!dialogue){dialogue=createDialogue(cell,200,"Destinations")}var table=dialogue.find("table").first();table.children().remove();var dataDestinations=[];if(propertyObject[property.key]){dataDestinations=propertyObject[property.key]}var text="";for(var i=0;i<dataDestinations.length;i++){var itemControl=getControlById(dataDestinations[i].itemId);text+=(itemControl?itemControl.name:dataDestinations[i].itemId);if(i<dataDestinations.length-1){text+=","}}if(!text){text="Click to add..."}cell.text(text);table.append("<tr><td><b>Control</b></td><td colspan='2'><b>Field</b></td></tr>");for(var i=0;i<dataDestinations.length;i++){var dataDestination=dataDestinations[i];var itemControl=getControlById(dataDestination.itemId);table.append("<tr><td>"+(itemControl?itemControl.name:dataDestination.itemId)+"</td><td><input value='"+dataDestination.field+"' /></td><td><img class='delete' src='images/bin_16x16.png' style='float:right;' /><img class='reorder' src='images/moveUpDown_16x16.png' style='float:right;' /></td></tr>");
var editField=table.find("tr").last().children("td:nth(1)").children("input");_listeners.push(editField.keyup({dataDestinations:dataDestinations},function(ev){var editField=$(ev.target);ev.data.dataDestinations[editField.parent().parent().index()-1].field=editField.val()}));var imgDelete=table.find("tr").last().children().last().children("img.delete");_listeners.push(imgDelete.click({dataDestinations:dataDestinations},function(ev){var imgDelete=$(ev.target);ev.data.dataDestinations.splice(imgDelete.parent().parent().index()-1,1);imgDelete.parent().parent().remove()}))}addReorder(dataDestinations,table.find("img.reorder"),function(){Property_dataDestinations(cell,propertyObject,property,refreshHtml,dialogue)});table.append("<tr><td colspan='3' style='padding:0px;'><select style='margin:0px'><option value=''>Add destination...</option>"+getOutputOptions()+"</select></td></tr>");var destinationAdd=table.find("tr").last().children().last().children().last();_listeners.push(destinationAdd.change({cell:cell,propertyObject:propertyObject,refreshHtml:refreshHtml,dialogue:dialogue},function(ev){if(!ev.data.propertyObject.dataDestinations){ev.data.propertyObject.dataDestinations=[]
}var dataDestinations=ev.data.propertyObject.dataDestinations;dataDestinations.push({itemId:$(ev.target).val(),field:""});Property_dataDestinations(ev.data.cell,ev.data.propertyObject,{key:"dataDestinations"},ev.data.refreshHtml,ev.data.dialogue)}))}function Property_controlHints(cell,hints,property,refreshHtml,refreshDialogue){var dialogue=refreshDialogue;if(!dialogue){dialogue=createDialogue(cell,400,"Control hints")}var table=dialogue.find("table").first();table.children().remove();var text="";var controlHints=hints.controlHints;if(!controlHints||controlHints=="[]"){controlHints=[]}table.append("<tr><td><b>Control</b></td><td><b>Action</b></td><td style='min-width:150px;max-width:150px;'><b>Hint text</b></td><td colspan='2'><b>Style</b></td></td></tr>");for(var i in controlHints){var controlHint=controlHints[i];var control=getControlById(controlHint.controlId);if(control){text+=control.name}var typeOptions="<option value='hover'"+((controlHint.type=="hover")?" selected":"")+">hover</option><option value='click'"+((controlHint.type=="click")?" selected":"")+">click</option>";
table.append("<tr><td><select class='control'><option value=''>Please select...</option>"+getControlOptions(controlHint.controlId)+"</select></td><td><select class='type'>"+typeOptions+"</select></td><td><span>"+controlHint.text+"</span></td><td><input value='"+controlHint.style+"'/></td><td style='width:32px;'><img class='delete' src='images/bin_16x16.png' style='float:right;' /><img class='reorder' src='images/moveUpDown_16x16.png' style='float:right;' /></td></tr>");if(i<controlHints.length-1){text+=","}}if(!text){text="Click to add..."}cell.text(text);var controlSelects=table.find("select.control");_listeners.push(controlSelects.change({controlHints:controlHints},function(ev){var select=$(ev.target);ev.data.controlHints[select.parent().parent().index()-1].controlId=select.val()}));var typeSelects=table.find("select.type");_listeners.push(typeSelects.change({controlHints:controlHints},function(ev){var select=$(ev.target);ev.data.controlHints[select.parent().parent().index()-1].type=select.val()
}));var texts=table.find("span");texts.each(function(){var span=$(this);Property_bigtext(span.parent(),controlHints[span.parent().parent().index()-1],{key:"text"},false)});var styles=table.find("input");_listeners.push(styles.change({controlHints:controlHints},function(ev){var input=$(ev.target);ev.data.controlHints[input.parent().parent().index()-1].style=input.val()}));var deleteImages=table.find("img.delete");_listeners.push(deleteImages.click({controlHints:controlHints},function(ev){var input=$(ev.target);ev.data.controlHints.splice(input.parent().parent().index()-1,1);input.parent().parent().remove();rebuildHtml(controlHints)}));addReorder(controlHints,table.find("img.reorder"),function(){rebuildHtml(hints);Property_controlHints(cell,hints,{key:"controlHints"},refreshHtml,dialogue)});table.append("<tr><td colspan='4'><a href='#'>add...</a></td></tr>");var add=table.find("tr").last().children().last().children().last();_listeners.push(add.click({cell:cell,hints:hints,refreshHtml:refreshHtml,dialogue:dialogue},function(ev){if(!ev.data.hints.controlHints){ev.data.hints.controlHints=[]
}ev.data.hints.controlHints.push({controlId:"",type:"hover",text:"",style:""});Property_controlHints(ev.data.cell,ev.data.hints,{key:"controlHints"},ev.data.refreshHtml,ev.data.dialogue)}))}function Property_slidePanelVisibility(cell,propertyObject,property,refreshHtml,refreshProperties){cell.text(propertyObject.visible);_listeners.push(cell.click(function(ev){addUndo();var slidePanel=propertyObject;slidePanel.visible=!slidePanel.visible;if(slidePanel.visible){slidePanel.object.addClass("slidePanelOpen");slidePanel.object.removeClass("slidePanelClosed")}else{slidePanel.object.addClass("slidePanelClosed");slidePanel.object.removeClass("slidePanelOpen")}rebuildHtml(propertyObject);$(ev.target).text(slidePanel.visible)}))}function Property_device(cell,propertyObject,property,refreshHtml,refreshProperties){var options="";for(var i in _devices){if(i*1==_device){options+="<option value='"+i+"' selected='selected'>"+_devices[i].name+"</option>"}else{options+="<option value='"+i+"'>"+_devices[i].name+"</option>"
}}cell.append("<select class='propertiesPanelTable'>"+options+"</select>");var select=cell.children().last();_listeners.push(select.change(function(ev){_device=$(ev.target).val()*1;if(typeof(localStorage)!=="undefined"){localStorage.setItem("_device",_device)}_scale=_ppi/_devices[_device].ppi*_devices[_device].scale*_zoom;windowResize("_device")}));if(!propertyObject[property.key]){propertyObject[property.key]=select.val()*1}}function Property_zoom(cell,propertyObject,property,refreshHtml,refreshProperties){var options="";var values=[[0.5,"50%"],[1,"100%"],[1.5,"150%"],[2,"200%"],[3,"300%"],[4,"400%"]];for(var i in values){if(values[i][0]==_zoom){options+="<option value='"+values[i][0]+"' selected='selected'>"+values[i][1]+"</option>"}else{options+="<option value='"+values[i][0]+"'>"+values[i][1]+"</option>"}}cell.append("<select class='propertiesPanelTable'>"+options+"</select>");var select=cell.children().last();_listeners.push(select.change(function(ev){_zoom=$(ev.target).val()*1;if(typeof(localStorage)!=="undefined"){localStorage.setItem("_zoom",_zoom)
}_scale=_ppi/_devices[_device].ppi*_devices[_device].scale*_zoom;windowResize("_zoom")}))}function Property_orientation(cell,propertyObject,property,refreshHtml,refreshProperties){if(_orientation=="P"){cell.text("Portrait")}else{cell.text("Landscape")}_listeners.push(cell.click(function(ev){if(_orientation=="P"){_orientation="L";$(ev.target).text("Landscape")}else{_orientation="P";$(ev.target).text("Portrait")}if(typeof(localStorage)!=="undefined"){localStorage.setItem("_orientation",_orientation)}windowResize("_orientation")}))}var _mobileActionTypes=[["addImage","Add image"],["uploadImages","Upload images"],["showGPS","Send gps position"]];function Property_mobileActionType(cell,mobileAction,property,refreshHtml,refreshProperties){var selectHtml="<select>";for(var i in _mobileActionTypes){selectHtml+="<option value='"+_mobileActionTypes[i][0]+"'"+(mobileAction.actionType==_mobileActionTypes[i][0]?" selected='selected'":"")+">"+_mobileActionTypes[i][1]+"</option>"}selectHtml+="</select>";
var actionTypeSelect=cell.append(selectHtml).find("select");setPropertyVisibilty(mobileAction,"galleryControlId",false);setPropertyVisibilty(mobileAction,"imageMaxSize",false);setPropertyVisibilty(mobileAction,"imageQuality",false);setPropertyVisibilty(mobileAction,"successActions",false);setPropertyVisibilty(mobileAction,"errorActions",false);switch(mobileAction.actionType){case"addImage":setPropertyVisibilty(mobileAction,"galleryControlId",true);setPropertyVisibilty(mobileAction,"imageMaxSize",true);setPropertyVisibilty(mobileAction,"imageQuality",true);break;case"uploadImages":setPropertyVisibilty(mobileAction,"galleryControlId",true);setPropertyVisibilty(mobileAction,"successActions",true);setPropertyVisibilty(mobileAction,"errorActions",true);break}_listeners.push(actionTypeSelect.change(function(ev){mobileAction.actionType=$(ev.target).val();Property_mobileActionType(cell,mobileAction,property,refreshHtml,refreshProperties);showEvents(_selectedControl)}))};