<?xml version="1.0" encoding="UTF-8" ?>
<actions xmlVersion="1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../schemas/action.xsd">

<!-- 

Copyright (C) 2020 - Gareth Edwards / Rapid Information Systems

gareth.edwards@rapid-is.co.uk


This file is part of the Rapid Application Platform

Rapid is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version. The terms require you to include
the original copyright, and the license notice in all redistributions.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
in a file named "COPYING".  If not, see <http://www.gnu.org/licenses/>.

 -->

    <action>
    
        <type>mobile</type>
        <name>Mobile</name>
	    <class>com.rapid.actions.Mobile</class>
	    <helpHtml>Runs specialised actions for mobile devices (start a phone call, take a photo, scan a barcode, etc.).</helpHtml>
	    
	    <addToNewMobileApplications>true</addToNewMobileApplications>

		<properties>
		    
	        <property>
	            <key>actionType</key>
	            <name>Type</name>
	            <setConstructValueFunction>return "dial";</setConstructValueFunction>
	            <changeValueJavaScript>mobileActionType</changeValueJavaScript>
	            <refreshProperties>true</refreshProperties>
	            <helpHtml>Defines the type of mobile action that will be carried out, such as dialing a number, scanning a barcode or sending a GPS location.</helpHtml>
	        </property>
	        
	        <property>
	            <key>numberControlId</key>
	            <name>Phone number source</name>
	             <visible>false</visible>
	            <changeValueJavaScript>select</changeValueJavaScript>
	             <getValuesFunction>
	                <![CDATA[
return "<option value=''>Please select...</option>" + getInputOptions(this.numberControlId);
	                ]]>
	            </getValuesFunction>
	            <helpHtml>Sets where the phone number is coming from on the page.</helpHtml>
	        </property>
	        
	        <property>
	            <key>numberField</key>
	            <name>Phone number source field</name>
	             <visible>false</visible>
	            <changeValueJavaScript>text</changeValueJavaScript>
	            <helpHtml>Defines a more specific field for the phone number source. An example of use would be getting the phone number from a table cell within a table, where the cell is the field and the table is the source.</helpHtml>
	        </property>
	        
	        <property>
	            <key>emailControlId</key>
	            <name>Email address source</name>
	             <visible>false</visible>
	            <changeValueJavaScript>select</changeValueJavaScript>
	             <getValuesFunction>
	                <![CDATA[
return "<option value=''>Please select...</option>" + getInputOptions(this.numberControlId);
	                ]]>
	            </getValuesFunction>
	            <helpHtml>Sets where the email address is coming from on the page.</helpHtml>
	        </property>
	        
	        <property>
	            <key>emailField</key>
	            <name>Email address source field</name>
	             <visible>false</visible>
	            <changeValueJavaScript>text</changeValueJavaScript>
	            <helpHtml>Defines a more specific field for the email address source. An example of use would be getting the email address from a table cell within a table, where the cell is the field and the table is the source.</helpHtml>
	        </property>
	        
	        <property>
	            <key>subjectControlId</key>
	            <name>Subject source</name>
	             <visible>false</visible>
	            <changeValueJavaScript>select</changeValueJavaScript>
	             <getValuesFunction>
	                <![CDATA[
return "<option value=''>Please select...</option>" + getInputOptions(this.numberControlId);
	                ]]>
	            </getValuesFunction>
	            <helpHtml>Sets where the email subject is coming from on the page.</helpHtml>
	        </property>
	        
	        <property>
	            <key>subjectField</key>
	            <name>Email source field</name>
	             <visible>false</visible>
	            <changeValueJavaScript>text</changeValueJavaScript>
	            <helpHtml>Defines a more specific field for the email subject source. An example of use would be getting the email subject from a table cell within a table, where the cell is the field and the table is the source.</helpHtml>
	        </property>
	        
	        <property>
	            <key>numberControlId</key>
	            <name>Phone number source</name>
	             <visible>false</visible>
	            <changeValueJavaScript>select</changeValueJavaScript>
	             <getValuesFunction>
	                <![CDATA[
return "<option value=''>Please select...</option>" + getInputOptions(this.numberControlId);
	                ]]>
	            </getValuesFunction>
	            <helpHtml>Sets where the phone number is coming from on the page.</helpHtml>
	        </property>
	        
	        <property>
	            <key>numberField</key>
	            <name>Phone number source field</name>
	             <visible>false</visible>
	            <changeValueJavaScript>text</changeValueJavaScript>
	            <helpHtml>Defines a more specific field for the phone number source. An example of use would be getting the phone number from a table cell within a table, where the cell is the field and the table is the source.</helpHtml>
	        </property>
	        
	        <property>
	            <key>messageControlId</key>
	            <name>Message source</name>
	             <visible>false</visible>
	            <changeValueJavaScript>select</changeValueJavaScript>
	             <getValuesFunction>
	                <![CDATA[
return "<option value=''>Please select...</option>" + getInputOptions(this.messageControlId);
	                ]]>
	            </getValuesFunction>
	            <helpHtml>Sets where the message is coming from on the page.</helpHtml>
	        </property>
	        
	        <property>
	            <key>messageField</key>
	            <name>Message source field</name>
	             <visible>false</visible>
	            <changeValueJavaScript>text</changeValueJavaScript>
	            <helpHtml>Defines a more specific field for the message source. An example of use would be getting the message from a table cell within a table, where the cell is the field and the table is the source.</helpHtml>
	        </property>
	        
	        <property>
	            <key>urlControlId</key>
	            <name>URL source</name>
	             <visible>false</visible>
	            <changeValueJavaScript>select</changeValueJavaScript>
	             <getValuesFunction>
	                <![CDATA[
return "<option value=''>Please select...</option>" + getInputOptions(this.messageControlId);
	                ]]>
	            </getValuesFunction>
	            <helpHtml>Sets where the URL is coming from on the page.</helpHtml>
	        </property>
	        
	        <property>
	            <key>urlField</key>
	            <name>URL source field</name>
	             <visible>false</visible>
	            <changeValueJavaScript>text</changeValueJavaScript>
	            <helpHtml>Defines a more specific field for the URL source. An example of use would be getting the URL from a table cell within a table, where the cell is the field and the table is the source.</helpHtml>
	        </property>
	        
	        <property>
	            <key>captureMode</key>
	            <name>Mode</name>
	            <visible>false</visible>
	            <setConstructValueFunction>return "closePreview";</setConstructValueFunction>
	            <changeValueJavaScript>select</changeValueJavaScript>
	             <getValuesFunction>
	                <![CDATA[
return [["closePreview","Close preview"],["keepPreview","Keep preview open"],["showCapture","Show captured image/video"]];
	                ]]>
	            </getValuesFunction>
	            <helpHtml>Sets what to do after an image/video is captured.</helpHtml>
	        </property>
	        
	        <property>
	            <key>galleryControlId</key>
	            <name>Gallery control</name>
	            <visible>false</visible>
	            <changeValueJavaScript>select</changeValueJavaScript>
	            <getValuesFunction>
	                <![CDATA[
return "<option value=''>Please select...</option>" + getControlOptions(this.galleryControlId, null, "gallery");
	                ]]>
	            </getValuesFunction>
	            <helpHtml>Selects which gallery control to use on the page. You will need to have a gallery control on the page in order to use this.</helpHtml>
	        </property>
	        
	        <property>
	            <key>imageMaxSize</key>
	            <name>Max width/height (px)</name>
	            <visible>false</visible>
	            <setConstructValueFunction>return "500";</setConstructValueFunction>
	            <changeValueJavaScript>integer</changeValueJavaScript>
	            <helpHtml>Sets the maximum height and width of the gallery. By default it sets to 500 pixels in length and width.</helpHtml>
	        </property>
	        
	        <property>
	            <key>imageQuality</key>
	            <name>Quality (%)</name>
	            <visible>false</visible>
	            <setConstructValueFunction>return "50";</setConstructValueFunction>
	            <changeValueJavaScript>integer</changeValueJavaScript>
	            <helpHtml>Sets the quality of the image, in percentages. By default it sets the quality to 50% of that of the original.</helpHtml>
	        </property>
	        
	        <property>
	            <key>videoMaxDuration</key>
	            <name>Max duration (sec)</name>
	            <visible>false</visible>
	            <setConstructValueFunction>return "";</setConstructValueFunction>
	            <changeValueJavaScript>integer</changeValueJavaScript>
	            <helpHtml>Sets the maximum number of seconds a video can last.</helpHtml>
	        </property>
	        
	        <property>
	            <key>cameraSelectImage</key>
	            <name>Option to select</name>
	            <visible>false</visible>
	            <setConstructValueFunction>return true;</setConstructValueFunction>
	            <changeValueJavaScript>checkbox</changeValueJavaScript>
	            <helpHtml>Sets whether or not to offer the option of selecting an image from the device.</helpHtml>
	        </property>
	        
	        <property>
	            <key>remoteSource</key>
	            <name>Remote</name>
	            <visible>false</visible>
	            <setConstructValueFunction>return "false";</setConstructValueFunction>
	            <changeValueJavaScript>checkbox</changeValueJavaScript>
	            <helpHtml>Sets whether to capture the device's cameras or another running application.</helpHtml>
	        </property>
	        
	         <property>
	            <key>galleryControlIds</key>
	            <name>Controls</name>
	            <visible>false</visible>
	            <changeValueJavaScript>galleryControls</changeValueJavaScript>
	            <refreshProperties>true</refreshProperties>
	            <helpHtml>Sets the gallery or signature control on the page to put the image in to.</helpHtml>
	        </property>
	        
	         <property>
	            <key>barcodeDestinations</key>
	            <name>Destinations</name>
	            <visible>false</visible>
	            <changeValueJavaScript>datacopyDestinations</changeValueJavaScript>
	            <helpHtml>Sets the destination for where to place the barcode data on the page.</helpHtml>
	        </property>
	        
	        <property>
	            <key>successActions</key>
	            <name>Success actions</name>
	            <visible>false</visible>
	            <changeValueJavaScript>childActions</changeValueJavaScript>
	            <helpHtml>Allows you to set a success action for when the image is successfully imported into the control specified.</helpHtml>
	        </property>
	        
	        <property>
	            <key>errorActions</key>
	            <name>Error actions</name>
	            <visible>false</visible>
	            <changeValueJavaScript>childActions</changeValueJavaScript>
	            <helpHtml>Allows you to set an error action for when the image is not successfully imported into the control specified.</helpHtml>
	        </property>
	        	        
	        <property>
	            <key>navigateControlId</key>
	            <name>Navigate to source</name>
	             <visible>false</visible>
	            <changeValueJavaScript>select</changeValueJavaScript>
	             <getValuesFunction>
	                <![CDATA[
return "<option value=''>Please select...</option>" + getInputOptions(this.navigateControlId);
	                ]]>
	            </getValuesFunction>
	            <helpHtml>The control that holds the data of where we want to navigate to.</helpHtml>
	        </property>
	        
	        <property>
	            <key>navigateField</key>
	            <name>Navigate to source field</name>
	             <visible>false</visible>
	            <changeValueJavaScript>text</changeValueJavaScript>
	            <helpHtml>Defines a more specific field for the source of where we want to navigate to. An example of use would be from a table cell within a table, where the cell is the field and the table is the source.</helpHtml>
	        </property>
	        
	        <property>
	            <key>navigateSearchFields</key>
	            <name>Navigate to search fields</name>
	             <visible>false</visible>
	            <changeValueJavaScript>text</changeValueJavaScript>
	            <helpHtml>Fields in the navigate to source control to use to search for the location to navigate to.</helpHtml>
	        </property>
	        
	         <property>
	            <key>navigateMode</key>
	            <name>Navigation mode</name>
	            <visible>false</visible>
	            <setConstructValueFunction>
	                <![CDATA[
return "d";
	                ]]>
	            </setConstructValueFunction>
	            <changeValueJavaScript>select</changeValueJavaScript>
	            <getValuesFunction>
	                <![CDATA[
return [["d","driving"],["w","walking"],["b","cycling"],["transit","public transport"]];
	                ]]>
	            </getValuesFunction>
	            <helpHtml>Sets the type of transport being used to navigate, such as public transport.</helpHtml>
	        </property>
	        
	        <property>
	            <key>message</key>
	            <name>Message</name>
	            <visible>false</visible>
	            <changeValueJavaScript>bigtext</changeValueJavaScript>
	            <helpHtml>Sets a message to display in the status bar.</helpHtml>
	        </property>
	        	        	        
	        <property>
	            <key>gpsDestinations</key>
	            <name>Destinations</name>
	            <visible>false</visible>
	            <changeValueJavaScript>datacopyDestinations</changeValueJavaScript>
	            <helpHtml>Sets which control on the page will hold the GPS location sent.</helpHtml>
	        </property>
         	        
	        <property>
	            <key>gpsFrequency</key>
	            <name>Update frequency</name>
	            <visible>false</visible>
	            <setConstructValueFunction>return 0;</setConstructValueFunction>
	            <changeValueJavaScript>integer</changeValueJavaScript>
	            <helpHtml>Sets the number of seconds between the latest GPS position being sent. A value of 0 means the position will only be sent once.</helpHtml>
	        </property>
	        
	        <property>
	            <key>gpsCheck</key>
	            <name>Check GPS enabled</name>
	            <visible>false</visible>
	            <changeValueJavaScript>checkbox</changeValueJavaScript>
	            <helpHtml>Sets whether to check if the mobile device has GPS enabled or not.</helpHtml>
	        </property>
	        
	        <property>
	            <key>swipeDirection</key>
	            <name>Direction</name>
	            <visible>false</visible>
	            <setConstructValueFunction>return "left";</setConstructValueFunction>
	            <changeValueJavaScript>select</changeValueJavaScript>
	            <getValuesFunction>return ["left","right","down","up"];</getValuesFunction>
	            <helpHtml>The direction the fingers are swiped in</helpHtml>
	        </property>
	        
	        <property>
	            <key>swipeFingers</key>
	            <name>Number of fingers</name>
	            <visible>false</visible>
	            <setConstructValueFunction>return "any";</setConstructValueFunction>
	            <changeValueJavaScript>select</changeValueJavaScript>
	            <getValuesFunction>return ["any","1","2"];</getValuesFunction>
	            <helpHtml>The number of fingers used in the swipe</helpHtml>
	        </property>
	        
	        <property>
	            <key>swipeControl</key>
	            <name>Control</name>
	            <visible>false</visible>
	            <setConstructValueFunction>return "html";</setConstructValueFunction>
	            <changeValueJavaScript>select</changeValueJavaScript>
	            <getValuesFunction>
	                <![CDATA[
return "<option value=''>Please select...</option><option value ='html'" + (this.swipeControl == "html" ? "selected='selected'" : "") + ">page</option>" + getControlOptions(this.swipeControl);
	                ]]>
	            </getValuesFunction>
	            <helpHtml>The control the swipe is performed on</helpHtml>
	        </property>
	        	        	        
	        <property>
	            <key>onlineWorking</key>
	            <name>Working dialogue</name>
	            <visible>false</visible>
	            <changeValueJavaScript>navigationPage</changeValueJavaScript>
	            <helpHtml>Sets a page to appear as dialogue if the mobile device is connected online.</helpHtml>
	        </property>
	        
	        <property>
	            <key>onlineFail</key>
	            <name>Offline dialogue</name>
	            <visible>false</visible>
	            <changeValueJavaScript>navigationPage</changeValueJavaScript>
	            <helpHtml>Sets a page to appear as dialogue if the mobile device is not connected to the Internet.</helpHtml>
	        </property>
	        
	        <property>
	            <key>onlineActions</key>
	            <name>Actions</name>
	            <visible>false</visible>
	            <changeValueJavaScript>childActions</changeValueJavaScript>
	            <helpHtml>Allows you to define actions to be carried out applicable to the type. For example if the mobile device was swiped, or has an established internet connection.</helpHtml>
	        </property>
	        
	    </properties>
	    
		<resources>
		    
	        <resource>
	            <type>javascriptFile</type>
	            <contents>
	               scripts/controls/map.js
	            </contents>
            </resource>
            
	        <resource>
	            <type>javascriptLink</type>
	            <contents>scripts_min/jquery-touchSwipe-1.6.18.min.js</contents>
	        </resource>
	        
	        <resource>
	        	<type>css</type>
	        	<contents>

.cameraControlBasic {
	background: black;
	border: 2px solid #ccc;
	outline: none;
	padding: 10px;
	margin: 20px;
	border-radius: 50%;
	width: 60px;
	text-align: center;
	display: inline-block;
	cursor: pointer;
}

.cameraControl {
	background: black;
	outline: none;
	border-radius: 50%; 
	border-color: white;
    height: 70px;
    width: 70px;
    color: #FFF;
}

.cameraControl + .cameraControl {
    margin-left: 20px;
}

#captureCount {
    font-size: 16px;
    font-weight: 700;
    color: #FFF;
}

.cameraIcon {
	font-size: 38px;
	color: white;
}

#cameraVideoContainer {
	position:fixed; 
	left:0; 
	right:0; 
	top:0; 
	bottom:0; 
	width:100%; 
	height:100%;
	background: #111;
	z-index:1010;
	display: none;
}

#cameraPlayer {
	width:100%; 
	height:100%; 
	object-fit:contain;
}

.btnRecording {
	background: #A00;
}

	        	</contents>
	        </resource>
            
		</resources>
	    
		<actionJavaScript>
	        <![CDATA[ 
     
function Action_mobile(actionId, type) {
	// action callback
	alert("Callback for " + actionId + "." + type);
}

// a map of swipe handlers as the plugin only allows one handler to be registerd at a time
_swipeHandlers = {};

// a function to check the map of handlers and call any number of functions
function handleSwipe(event, direction, distance, duration, fingers, fingerData, target, ev) {
	// get the handlers for a target
	var handlers = _swipeHandlers[target];
	// loop them
	for (var i in handlers) {
		// get the hanlder
		var handler = handlers[i];
		// if the directions match and either the fingers match too, or are all/any, run the function!
		if (handler.direction == direction && (handler.fingers == fingers || handler.fingers == 0)) handler.function(ev);
	}
}

var _cameraPlayer;
var _availableCameras = [];
var _currentFacingMode = "user";
var _galleryControlId;
var _size;
var _quality;

function hasGetUserMedia() {

	// Return the value's truthy boolean value (e.g. if its null, will return false)
	return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)
	
}

function getAvailableCameras() {
	
	if (hasGetUserMedia()) {
		
		navigator.mediaDevices.enumerateDevices()
		.then(function(devices){
			
			devices.forEach(function(device){
			
				if (device.kind === "videoinput") {
					console.log(device.kind + ": " + device.label + " id = " + device.deviceId);
					_availableCameras.push(device.deviceId);

				}
				
			});
		
		})
		.catch(function(err){
			
			console.log(err.name + ": " + err.message);
			
		});
		
	}
	
}

var _mobileCamera = {
	getStream() {
		return navigator.mediaDevices.getUserMedia(constraints);
	},
	close() {
		if (hasGetUserMedia()) {
			// Close the preview
			$("#cameraVideoContainer").remove();
			
			// Stop all video streams attached to the video element
			if (_cameraPlayer && _cameraPlayer.srcObject && _cameraPlayer.srcObject.getVideoTracks) {
				_cameraPlayer.srcObject.getVideoTracks().forEach(function(track){
					track.stop();
				});
			}
		}
	}
};

var _mobileRemote = {
	stream: undefined,
	getStream() {
		if (this.stream) {
			return this.stream;
		} else {
			return this.stream = navigator.mediaDevices.getDisplayMedia()
		}
	},
	close() {
		if (hasGetUserMedia()) {
			// Close the preview
			$("#cameraVideoContainer").remove();
		}
	}
};

function turnOnCamera(galleryControlId, size, quality, maxDuration, cameraSelectImage, mediums, remoteSource, captureMode) {
	
	_size = size;
	_cameraSelectImage = cameraSelectImage;
	
	if (hasGetUserMedia()) {
		
		_galleryControlId = galleryControlId;
		_quality = quality;
		_cameraPlayer = document.getElementById("cameraPlayer");
		
	    var inputImageHtml = _cameraSelectImage ? "<div style='position:fixed; top:0; width:100%; text-align:center;'><label id='btnInputImage' for='inputImage' class='cameraControlBasic'><i class='fa fa-folder-open cameraIcon' style='margin-left: 2px;'></i></label>"
							  + "<input type='file' accept='image/*' id='inputImage' style='display:none;'></div>" : "";
	
		// Add the divs
		var cameraPreviewHtml = "<div id='cameraVideoContainer'>"
							+ "<video id='cameraPlayer' autoplay></video>"
							+ inputImageHtml
							+ "<button id='btnToggleCamera' class='cameraControlBasic' style='position:absolute; left:0;'><i class='fa fa-retweet cameraIcon' style='margin-left:-2px;'></i></button>"								  
							+ "<button id ='btnCloseCamera' class='cameraControlBasic' style='position:absolute; right:0;'><i class='fa fa-times cameraIcon'></i></button>"
							+ "<div style='position:fixed; bottom:0; width:100%; text-align:center; padding:20px;'>"
							+ (captureMode === "keepPreview" ? "<p id='captureCount'></p>" : "")
							+ (mediums.includes('image') ? "<button id ='btnTakePicture' class='cameraControl'><i class='fa fa-camera cameraIcon'></i></button>" : "")
							+ (mediums.includes('video') ? "<button id ='btnRecordVideo' class='cameraControl'><i class='fa fa-video-camera cameraIcon'></i></button>" : "")
							+ "</div>"
							+ "</div>";
		
		var source = remoteSource ? _mobileRemote : _mobileCamera;
		
		var galleryDetails = window[galleryControlId + "details"];
		
		$("body").append(cameraPreviewHtml);
		
		$("#btnToggleCamera").click(toggleCameraFacing);
		
		$("#btnCloseCamera").click(source.close);
		
		$("#btnInputImage").click(source.close);
		
		$("#inputImage").on("change", function(changeEvent) {
				
			var fileReader = new FileReader();
			
			$(fileReader).on("load", function(loadEvent) {
				
				var image = new Image();
				image.src = loadEvent.target.result;
				
				$(image).on("load", function(loadEvent) {
					
					var imageWidth = loadEvent.target.width;
					var imageHeight = loadEvent.target.height;
					
					// Get a data url of the canvas, containing a representation of the image
					// Default format type is image/png
					var dataURL = scaleImageToDataURL(image, image.width, image.height) || image.src;
			
					// call gallery set data to display image
					setData_gallery(loadEvent, galleryControlId, "url", galleryDetails, dataURL);
					
					$(".inputImagePage").remove();
				});
			});
			
			fileReader.readAsDataURL(this.files[0]);
		});
			
		_cameraPlayer = document.getElementById("cameraPlayer");
		
		_cameraPlayer.setAttribute("data-galleryId",galleryControlId);
		
		// Specify the types of media to request, along with any requirements for each type
		var constraints = {
		   video: {facingMode: _currentFacingMode}
		};
			
		// Display the cameraPlayer
		$("#cameraVideoContainer").show();

		// Obtain the user media object
		source.getStream()
		.then(function(stream) {
			
			// Use the stream
			// Now attach the video stream to the video element and auto play
			_cameraPlayer.srcObject = stream;
			
			if (!$("#cameraVideoContainer").length) {
				source.close();
				return;
			}
			
			$("#btnTakePicture").click(function() {
				capureMedia(takePicture(), captureMode, source);
			});
			
			var bitsPerSecond = (quality / 100) * (2500000 + 128000);
			
			if ($("#btnRecordVideo").length) btnRecordVideo.onclick = function() {
				recordVideo(stream, bitsPerSecond, maxDuration, function(data) {
					capureMedia(data, captureMode, source);
				});
			};
			
			$("#btnPause").click(function(ev) {
				pauseCamera(ev, galleryControlId, galleryDetails);
			});
			
			// Get all the available cameras into global array
			getAvailableCameras();
		})
		.catch(function(err) {
			// Close the preview
			$("#cameraVideoContainer").remove();
			// Handle the error
			console.log(err.name + ": " + err.message);
			if (source === "camera") selectImage(galleryControlId, _size);
		});
		
	} else {
	
		$("#cameraVideoContainer").remove();
		//alert("getUserMedia() is not supported by your browser");
		console.log("getUserMedia() is not supported by your browser");
		if (source === "camera") selectImage(galleryControlId, _size);
	}
	
}

function stopCameraStream() {

	if (hasGetUserMedia()) {
		// Stop all video streams attached to the video element
		_cameraPlayer.srcObject.getVideoTracks().forEach(function(track){
			// Close the preview
			track.stop();
		});
	}
	
}

function scaleImageToDataURL(image, imageWidth, imageHeight) {
	
	if (hasGetUserMedia()) {
		
		var maxSize = _size;
		
		var canvas = document.createElement("canvas");
		var canvasContext = canvas.getContext("2d");
		
		// Set the width and height of the canvas, before drawing
		// Find the longest side of the videoplayer
		if (imageHeight > imageWidth) {
			
			canvas.height = maxSize;
			canvas.width = (imageWidth / imageHeight) * maxSize;
			
		} else {
		
			canvas.height = (imageHeight / imageWidth) * maxSize;
			canvas.width = maxSize;
			
		}
		
		// Draw a single video frame in the player to the canvas
		canvasContext.drawImage(image, 0, 0, canvas.width, canvas.height);
		
		// Get a data url of the canvas, containing a representation of the image
		// Default format type is image/png
		return canvas.toDataURL();
		
	}
}

function selectImage(galleryControlId, size) {

	_size = size;
	
	var galleryDetails = window[galleryControlId + "details"];
	
	var inputHtml = "<input type='file' accept='image/*' id='inputImage' style='display:none;'>"
		+ "<label for='inputImage' class='r-button button btn col-xs-12' style='margin-top:1em;'>Choose from my files</label>";
		
	var closeButtonHtml = "<button id='closeInputPage' class='r-button button btn col-xs-12' style='min-width:200px; margin-top:1em; background:none; color:black;'>Cancel</button>";
	
	var inputPageHtml = "<div class='inputImagePage dialogueCover' style='position:absolute; left:0px; top:0px; z-index:1001; width:100vw; height:100vh;'>"
		+ "</div>"
		+ "<div class='inputImagePage dialogue' style='position:fixed; visibility:visible; z-index:1001;'>"
		+ "<h2 class='r-text col-xs-12'>Select an image</h2>"
		+ inputHtml
		+ closeButtonHtml
		+ "</div>"
	
	$("body").append(inputPageHtml);
	
	$(window).resize();
	
	$("#closeInputPage, .inputImagePage.dialogueCover").on("click", function() {
		$(".inputImagePage").remove();
	});
	
	$("#inputImage").on("change", function(changeEvent) {
		
		var fileReader = new FileReader();
		
		$(fileReader).on("load", function(loadEvent) {
			
			var image = new Image();
			image.src = loadEvent.target.result;
			
			$(image).on("load", function(loadEvent) {
				
				var imageWidth = loadEvent.target.width;
				var imageHeight = loadEvent.target.height;
				
				// Get a data url of the canvas, containing a representation of the image
				// Default format type is image/png
				var dataURL = scaleImageToDataURL(image, image.width, image.height) || image.src;
		
				// call gallery set data to display image
				setData_gallery(loadEvent, galleryControlId, "url", galleryDetails, dataURL);
				
				$(".inputImagePage").remove();
			});
		});
		
		fileReader.readAsDataURL(this.files[0]);
	});
}

function capureMedia(data, captureMode, source) {
	
	var galleryControlId = _cameraPlayer.getAttribute("data-galleryId");
	var galleryDetails = window[galleryControlId + "details"];
	
	if (captureMode === "keepPreview") {
		
		var captureCount = parseInt($("#captureCount").text() || 0);
		$("#captureCount").text(captureCount + 1);
		setData_gallery(data.ev, galleryControlId, "url", galleryDetails, data.dataURL);
		
	} else if (captureMode === "showCapture") {
		
		setData_gallery(data.ev, galleryControlId, "url", galleryDetails, data.dataURL);
		var img = $("#" + galleryControlId).find(".galleryItem").last();
		Gallery_showImage(data.ev, galleryControlId, img, true);
		
	} else { // send captured media to gallery and close preview
		
		setData_gallery(data.ev, galleryControlId, "url", galleryDetails, data.dataURL);
		source.close();
		
	}
}

function takePicture(ev) {
	
	if (hasGetUserMedia()) {
		
		// Get the intrinsic width and height of the videoplayer
		var vWidth = _cameraPlayer.videoWidth;
		var vHeight = _cameraPlayer.videoHeight;
		
		// Get a data url of the canvas, containing a representation of the image
		// Default format type is image/png
		var dataURL = scaleImageToDataURL(_cameraPlayer, _cameraPlayer.videoWidth, _cameraPlayer.videoHeight);
		
		return { dataURL, ev };
	}
}

function recordVideo(stream, bitsPerSecond, maxDuration, callback) {
	
	var chunks = [];
	
	var mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm", bitsPerSecond });
	mediaRecorder.start();
	
	$("#btnRecordVideo").addClass("btnRecording");
	
	function stopRecording() {
		$("#btnRecordVideo").removeClass("btnRecording");
		mediaRecorder.stop();
	};
	
	btnRecordVideo.onclick = stopRecording;
	
	if (maxDuration > 0) setTimeout(stopRecording, maxDuration * 1000);
	
	mediaRecorder.onstop = function(ev) {
		var blob = new Blob(chunks, { type: "video/webm" });
		var dataURL = URL.createObjectURL(blob);
		callback({ dataURL, ev });
	};
	
	mediaRecorder.ondataavailable = function(ev) {
		chunks.push(ev.data);
	};
}

function toggleCameraFacing () {
	
	if (_availableCameras.length > 1) {
		
		if (_currentFacingMode === "environment") {
			_currentFacingMode = "user";
		} else {
			_currentFacingMode = "environment";
		}
		
		stopCameraStream ();
		turnOnCamera(_galleryControlId, _size, _quality, 'camera', false);
		
	}

}

function base64toBlob(base64Data, contentType) {

    contentType = contentType || '';
    var sliceSize = 1024;
    // The atob function will decode a base64-encoded string into a new string with a character for each byte of the binary data.
    var byteCharacters = atob(base64Data);
    var bytesLength = byteCharacters.length;
    var slicesCount = Math.ceil(bytesLength / sliceSize);
    var byteArrays = new Array(slicesCount);
    for (var sliceIndex = 0; sliceIndex < slicesCount; ++sliceIndex) {
        var begin = sliceIndex * sliceSize;
        var end = Math.min(begin + sliceSize, bytesLength);

        var bytes = new Array(end - begin);
        for (var offset = begin, i = 0; offset < end; ++i, ++offset) {
            bytes[i] = byteCharacters[offset].charCodeAt(0);
        }
        // Convert this array of byte values into a real typed byte array by passing it to the Uint8Array constructor.
        byteArrays[sliceIndex] = new Uint8Array(bytes);
    }
    // Convert byte array to a Blob
    return new Blob(byteArrays, { type: contentType });
    
}

var _uploadedImageNames;
var _uploadedImageErrored;

function uploadImages(controlIds, ev, successCallback, errorCallback) {

	// reset uploaded images - we'll use this later to empty the session once all images are uploaded
	_uploadedImageNames = [];
	// reset uploaded image error to false - we'll use this to ensure only the first error is shown/handled
	_uploadedImageErrored = false;

	// If we have one
	if (controlIds && controlIds.length > 0) {
		
		// Loop the control ids, will be gallery or a signature, for gallery get all images, upload use data-filename attribute as file name, on success
		
		// images we are going to upload
		var images = [];
		
		for (var idx in controlIds) {
		
			var controlId = controlIds[idx];
		
			var control = $("#" + controlId);
			
			// Check if this is a gallery control or signature
			if (control.hasClass("gallery")) {
			
				// Get all the images from the control
				control.find("img").each(function(){
					
					var img = $(this);
					
					var src = img.attr("src");
					
					if (src.indexOf("data") == 0) images.push({url:"~?a=" + _appId + "&action=uploadImage&name=" + img.attr("data-filename"), dataURL:src});
										
				});
			
			} else if (control.hasClass("signature")) {
												
				// Its a signature control - get the dataUrl from the signature
				// Get a data url of the canvas, containing a representation of the image
				// Default format type is image/png
				
				var signature = _signatureControls[controlId];

				// Get the current date
				var date = new Date();
				var dateString = date.getFullYear() + "" + padNumberWithZeros(date.getMonth() + 1,2) + "" + padNumberWithZeros(date.getDate(),2) + "_" + padNumberWithZeros(date.getHours(),2) + "" + padNumberWithZeros(date.getMinutes(),2) + "" + padNumberWithZeros(date.getSeconds(),2) + "" + padNumberWithZeros(date.getMilliseconds(),3);
				var fileName = 	dateString + ".png";

				images.push({url:"~?a=" + _appId + "&action=uploadImage&name=" + fileName, dataURL:signature.toDataURL()});
							
			}
			
		}
		
		// if there are any no images to upload
		if (images.length == 0) {
			
			// call the success immediately, if there is one
			if (successCallback) window[successCallback](ev);
			
		} else {
		
			// make a progress object set total uploads to size of images
			var progress = {totalUploads:images.length, totalUploaded:0};
			
			// loop images to upload
			for (var i in images) {
				// get the image
				var image = images[i];
				// send it for uploading
				uploadImage(image.url, image.dataURL, progress, ev, successCallback, errorCallback);
			}
			
		}
		
	}
	
}

function uploadImage(url, dataSource, progress, ev, successCallback, errorCallback) {

	try {

		var sourceParts = dataSource.split(",");
		var dataString = "data:";
		var contentType = "";
		
		if (sourceParts && sourceParts.length && sourceParts[0].indexOf(dataString) > -1) {
		
			// If dataSource starts with data: dig out contentType
			var dataParts = sourceParts[0].split(";");
			
			contentType = dataParts[0].substring(dataString.length);
			
			dataSource = sourceParts[1];
		}
		
		var data = base64toBlob(dataSource, contentType);
		
		var namePos = url.indexOf("name=");
		
		var name = url.slice(namePos + 5);
		
		// POST
		$.ajax({
			url:url,
			type:"POST",
			processData: false,  	// tell jQuery not to process the data
	   		contentType: false,  	// tell jQuery not to set contentType
			data: data,
			success: function(ev) {
				// in total uploaded
				progress.totalUploaded ++;
				// if name and session storage
				if (name && sessionStorage) _uploadedImageNames.push(name);
				// if all uploaded
				if (progress.totalUploaded == progress.totalUploads) {
					// if session storage
					if (sessionStorage) {
						// get app images storage string
						var imageStorageString = sessionStorage[_appId + "_images"];
						// if there was one
						if (imageStorageString) {
							// parse to object
							var imageStorage = JSON.parse(imageStorageString);
							// loop uploaded image names
							for (var i in _uploadedImageNames) {
								// get uploaded name
								var uploadedName = _uploadedImageNames[i];
								// delete if present
								if (imageStorage[uploadedName]) delete imageStorage[uploadedName];
							}
						    // re-stringify image storage object
						    imageStorageString = JSON.stringify(imageStorage);
						    // save it back to session
						    sessionStorage[_appId + "_images"] = imageStorageString;
						}
					}
					// call callback if there is one
					if (successCallback) window[successCallback](ev);
				}
			},
			error: function(server, status, message) {
				// if we have not had an error yet
				if (!_uploadedImageErrored) {
					// remember this one
					_uploadedImageErrored = true;
					// if there is an error call back 
					if (errorCallback) {
						// call it
						window[errorCallback](ev, server, status, message);
					} else {
						// otherwise show an alert
						alert("Error uploading images: " + server.statusText||message);
					}
				}
			}
		});
		
	} catch(ex) {
	
		if (errorCallback) {
			window[errorCallback](ev);
		} else {
			throw ex;
		}
	
	}

}
			]]>
	    </actionJavaScript>
	  
    </action> 
</actions>